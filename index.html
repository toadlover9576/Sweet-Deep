<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sweet Deep Enhanced</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  
  :root{
    --bg-start:#0a0e27;
    --bg-end:#1a1f3a;
    --card:rgba(255,255,255,0.03);
    --card-hover:rgba(255,255,255,0.06);
    --glass:rgba(255,255,255,0.08);
    --border:rgba(255,255,255,0.1);
    --text:#e8eaf6;
    --text-muted:#9ca3af;
    --accent:#6366f1;
    --accent-glow:rgba(99,102,241,0.3);
    --accent-2:#8b5cf6;
    --success:#10b981;
    --warning:#f59e0b;
    --danger:#ef4444;
    --shadow:0 20px 60px rgba(0,0,0,0.3);
    --glow:0 0 20px var(--accent-glow);
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
  }
  
  *{box-sizing:border-box;}
  
  html,body{
    height:100%;
    margin:0;
    background:linear-gradient(135deg,var(--bg-start),var(--bg-end));
    color:var(--text);
    overflow-x:hidden;
  }
  
  body{
    background-image:
      radial-gradient(at 20% 30%, rgba(99,102,241,0.15) 0px, transparent 50%),
      radial-gradient(at 80% 70%, rgba(139,92,246,0.15) 0px, transparent 50%);
  }
  
  .wrap{
    max-width:1400px;
    margin:0 auto;
    padding:24px;
    display:grid;
    gap:20px;
    grid-template-columns:1fr 380px;
    animation:fadeIn 0.6s ease;
  }
  
  @media (max-width:1100px){
    .wrap{grid-template-columns:1fr;}
  }
  
  @keyframes fadeIn{
    from{opacity:0;transform:translateY(20px)}
    to{opacity:1;transform:translateY(0)}
  }
  
  header{
    display:flex;
    align-items:center;
    gap:16px;
    margin-bottom:20px;
  }
  
  .logo{
    width:64px;
    height:64px;
    border-radius:16px;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-weight:700;
    font-size:24px;
    box-shadow:var(--glow);
    animation:pulse 3s ease-in-out infinite;
  }
  
  @keyframes pulse{
    0%,100%{transform:scale(1)}
    50%{transform:scale(1.05)}
  }
  
  h1{
    margin:0;
    font-size:32px;
    font-weight:700;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  
  .lead{
    margin:4px 0 0;
    color:var(--text-muted);
    font-size:14px;
  }
  
  .card{
    background:var(--card);
    backdrop-filter:blur(20px);
    border:1px solid var(--border);
    border-radius:20px;
    padding:24px;
    box-shadow:var(--shadow);
    transition:all 0.3s ease;
  }
  
  .card:hover{
    background:var(--card-hover);
    transform:translateY(-2px);
  }
  
  .card   h2{
    margin:0 0 12px;
    font-size:20px;
    font-weight:600;
  }
  
  .tiny{
    font-size:13px;
    color:var(--text-muted);
    line-height:1.5;
  }
  
  /* Breathing Circle */
  .breath-container{
    text-align:center;
    padding:20px 0;
  }
  
  .circle{
    width:220px;
    height:220px;
    border-radius:50%;
    margin:20px auto;
    display:flex;
    align-items:center;
    justify-content:center;
    background:radial-gradient(circle at 40% 30%, rgba(99,102,241,0.2), rgba(139,92,246,0.1));
    border:2px solid var(--border);
    transition:all 1s cubic-bezier(0.4,0,0.2,1);
    box-shadow:0 0 40px rgba(99,102,241,0.3), inset 0 0 60px rgba(99,102,241,0.1);
    position:relative;
  }
  
  .circle::before{
    content:'';
    position:absolute;
    inset:-2px;
    border-radius:50%;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    opacity:0;
    transition:opacity 0.5s;
    z-index:-1;
    filter:blur(20px);
  }
  
  .circle.active::before{
    opacity:0.4;
  }
  
  .circle-label{
    font-size:24px;
    font-weight:600;
    color:var(--accent);
    text-shadow:0 0 20px var(--accent-glow);
  }
  
  /* Controls */
  .controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    margin-top:16px;
  }
  
  button,select{
    border:0;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    color:white;
    padding:12px 20px;
    border-radius:12px;
    cursor:pointer;
    font-weight:600;
    font-size:14px;
    transition:all 0.3s ease;
    box-shadow:0 4px 12px var(--accent-glow);
  }
  
  button:hover:not(:disabled){
    transform:translateY(-2px);
    box-shadow:0 6px 20px var(--accent-glow);
  }
  
  button:disabled{
    opacity:0.5;
    cursor:not-allowed;
  }
  
  button.secondary{
    background:var(--glass);
    border:1px solid var(--border);
    box-shadow:none;
  }
  
  button.danger{
    background:linear-gradient(135deg,var(--danger),#dc2626);
  }
  
  select{
    background:var(--glass);
    border:1px solid var(--border);
    padding:10px 16px;
    cursor:pointer;
  }
  
  input[type="text"],input[type="number"],textarea{
    width:100%;
    padding:12px 16px;
    border-radius:12px;
    border:1px solid var(--border);
    background:var(--glass);
    color:var(--text);
    font-size:14px;
    transition:all 0.3s;
  }
  
  input:focus,textarea:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 3px var(--accent-glow);
  }
  
  textarea{
    resize:vertical;
    min-height:80px;
    font-family:inherit;
  }
  
  label{
    display:block;
    margin-bottom:8px;
    color:var(--text-muted);
    font-size:13px;
    font-weight:500;
  }
  
  /* Meters and Progress */
  .meter{
    height:12px;
    background:var(--glass);
    border-radius:999px;
    overflow:hidden;
    border:1px solid var(--border);
    position:relative;
  }
  
  .meter-fill{
    height:100%;
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    transition:width 0.5s cubic-bezier(0.4,0,0.2,1);
    position:relative;
    box-shadow:0 0 10px var(--accent-glow);
  }
  
  .meter-fill::after{
    content:'';
    position:absolute;
    inset:0;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);
    animation:shimmer 2s infinite;
  }
  
  @keyframes shimmer{
    0%{transform:translateX(-100%)}
    100%{transform:translateX(100%)}
  }
  
  /* Timer Display */
  .timer-display{
    font-size:64px;
    font-weight:700;
    text-align:center;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
    text-shadow:0 0 40px var(--accent-glow);
    margin:20px 0;
    font-variant-numeric:tabular-nums;
  }
  
  /* Focus Meter - Enhanced */
  .focus-meter-container{
    margin:20px 0;
    padding:20px;
    background:var(--glass);
    border-radius:16px;
    border:1px solid var(--border);
  }
  
  .focus-score{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:16px;
  }
  
  .score-value{
    font-size:48px;
    font-weight:700;
    background:linear-gradient(135deg,var(--success),#059669);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  
  .score-value.warning{
    background:linear-gradient(135deg,var(--warning),#d97706);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }
  
  .score-value.danger{
    background:linear-gradient(135deg,var(--danger),#dc2626);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }
  
  .focus-metrics{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
    gap:12px;
    margin-top:16px;
  }
  
  .metric{
    background:rgba(0,0,0,0.2);
    padding:12px;
    border-radius:12px;
    border:1px solid var(--border);
  }
  
  .metric-label{
    font-size:11px;
    color:var(--text-muted);
    text-transform:uppercase;
    letter-spacing:0.5px;
    margin-bottom:4px;
  }
  
  .metric-value{
    font-size:20px;
    font-weight:600;
    color:var(--text);
  }
  
  /* Task Notes System */
  .note-input-area{
    margin-bottom:16px;
  }
  
  .note-item{
    background:var(--glass);
    border:1px solid var(--border);
    border-radius:12px;
    padding:16px;
    margin-bottom:12px;
    transition:all 0.3s ease;
    animation:slideIn 0.3s ease;
  }
  
  @keyframes slideIn{
    from{opacity:0;transform:translateX(-20px)}
    to{opacity:1;transform:translateX(0)}
  }
  
  .note-item:hover{
    background:var(--card-hover);
    transform:translateX(4px);
  }
  
  .note-header{
    display:flex;
    justify-content:space-between;
    align-items:start;
    margin-bottom:8px;
  }
  
  .note-priority{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 14px;
    border-radius:8px;
    font-size:11px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.8px;
  }
  
  .priority-critical{
    background:linear-gradient(135deg,rgba(239,68,68,0.2),rgba(220,38,38,0.3));
    color:#fca5a5;
    border:1px solid rgba(239,68,68,0.4);
    box-shadow:0 0 10px rgba(239,68,68,0.2);
  }
  
  .priority-urgent{
    background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(217,119,6,0.3));
    color:#fcd34d;
    border:1px solid rgba(245,158,11,0.4);
    box-shadow:0 0 10px rgba(245,158,11,0.2);
  }
  
  .priority-standard{
    background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(79,70,229,0.3));
    color:#c7d2fe;
    border:1px solid rgba(99,102,241,0.4);
    box-shadow:0 0 10px rgba(99,102,241,0.2);
  }
  
  /* Priority Selector */
  .priority-selector{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:10px;
    margin-bottom:16px;
  }
  
  .priority-option{
    position:relative;
  }
  
  .priority-option input[type="radio"]{
    position:absolute;
    opacity:0;
    width:0;
    height:0;
  }
  
  .priority-label{
    display:block;
    padding:14px 12px;
    border-radius:12px;
    border:2px solid var(--border);
    background:var(--glass);
    cursor:pointer;
    transition:all 0.3s ease;
    text-align:center;
    font-size:12px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  
  .priority-option input:checked + .priority-label{
    border-color:currentColor;
    transform:translateY(-2px);
  }
  
  .priority-label.label-critical{
    color:#fca5a5;
  }
  
  .priority-option input:checked + .priority-label.label-critical{
    background:linear-gradient(135deg,rgba(239,68,68,0.2),rgba(220,38,38,0.3));
    box-shadow:0 0 20px rgba(239,68,68,0.3);
  }
  
  .priority-label.label-urgent{
    color:#fcd34d;
  }
  
  .priority-option input:checked + .priority-label.label-urgent{
    background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(217,119,6,0.3));
    box-shadow:0 0 20px rgba(245,158,11,0.3);
  }
  
  .priority-label.label-standard{
    color:#c7d2fe;
  }
  
  .priority-option input:checked + .priority-label.label-standard{
    background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(79,70,229,0.3));
    box-shadow:0 0 20px rgba(99,102,241,0.3);
  }
  
  .priority-indicator{
    display:block;
    width:8px;
    height:8px;
    border-radius:50%;
    margin:0 auto 6px;
    background:currentColor;
    box-shadow:0 0 8px currentColor;
  }
  
  .note-actions{
    display:flex;
    gap:6px;
  }
  
  .note-btn{
    background:transparent;
    border:none;
    color:var(--text-muted);
    cursor:pointer;
    padding:4px 8px;
    border-radius:6px;
    font-size:12px;
    transition:all 0.2s;
  }
  
  .note-btn:hover{
    background:var(--glass);
    color:var(--text);
    transform:none;
  }
  
  .note-content{
    color:var(--text);
    line-height:1.6;
    font-size:14px;
  }
  
  .note-timestamp{
    font-size:11px;
    color:var(--text-muted);
    margin-top:8px;
  }
  
  /* Pills and Badges */
  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    background:var(--glass);
    padding:8px 14px;
    border-radius:999px;
    font-size:13px;
    font-weight:600;
    border:1px solid var(--border);
  }
  
  .pill-dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:var(--accent);
    animation:blink 2s ease-in-out infinite;
  }
  
  @keyframes blink{
    0%,100%{opacity:1}
    50%{opacity:0.3}
  }
  
  /* Event Log */
  .event-log{
    max-height:300px;
    overflow-y:auto;
    padding:12px;
    background:rgba(0,0,0,0.2);
    border-radius:12px;
    border:1px solid var(--border);
  }
  
  .event-log::-webkit-scrollbar{
    width:6px;
  }
  
  .event-log::-webkit-scrollbar-track{
    background:transparent;
  }
  
  .event-log::-webkit-scrollbar-thumb{
    background:var(--border);
    border-radius:3px;
  }
  
  .event-item{
    padding:8px 12px;
    margin-bottom:6px;
    background:var(--glass);
    border-radius:8px;
    font-size:12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    animation:slideIn 0.3s ease;
  }
  
  .event-time{
    color:var(--text-muted);
    font-size:11px;
  }
  
  .delete-event{
    background:transparent;
    border:none;
    color:var(--danger);
    cursor:pointer;
    padding:2px 6px;
    opacity:0.6;
    transition:opacity 0.2s;
    font-size:11px;
  }
  
  .delete-event:hover{
    opacity:1;
    transform:none;
  }
  
  /* Stats Grid */
  .stats-grid{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:12px;
    margin-top:16px;
  }
  
  .stat-card{
    background:var(--glass);
    padding:16px;
    border-radius:12px;
    border:1px solid var(--border);
    text-align:center;
  }
  
  .stat-value{
    font-size:32px;
    font-weight:700;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  
  .stat-label{
    font-size:12px;
    color:var(--text-muted);
    text-transform:uppercase;
    letter-spacing:0.5px;
    margin-top:4px;
  }
  
  /* Toggle Switch */
  .switch{
    position:relative;
    display:inline-block;
    width:48px;
    height:24px;
  }
  
  .switch input{
    opacity:0;
    width:0;
    height:0;
  }
  
  .slider{
    position:absolute;
    cursor:pointer;
    inset:0;
    background:var(--glass);
    border:1px solid var(--border);
    transition:0.4s;
    border-radius:24px;
  }
  
  .slider:before{
    position:absolute;
    content:"";
    height:16px;
    width:16px;
    left:3px;
    bottom:3px;
    background:white;
    transition:0.4s;
    border-radius:50%;
  }
  
  input:checked + .slider{
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
  }
  
  input:checked + .slider:before{
    transform:translateX(24px);
  }
  
  /* Responsive */
  @media (max-width:600px){
    .timer-display{font-size:48px}
    .score-value{font-size:36px}
    .stats-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<main class="wrap">
  <section>
    <header>
      <div class="logo">SD</div>
      <div>
        <h1>Sweet Deep Enhanced</h1>
        <p class="lead">Advanced focus restoration with intelligent attention tracking and task management</p>
      </div>
    </header>

    <!-- Focus Task Manager -->
    <div class="card">
      <h2>Focus Task Manager</h2>
      <p class="tiny">Capture what you need to focus on right now. Set priority and track completion.</p>
      
      <div class="note-input-area">
        <label>What needs your attention?</label>
        <textarea id="noteText" placeholder="Write one clear, specific task or goal..."></textarea>
        
        <label style="margin-top:16px">Priority Level</label>
        <div class="priority-selector">
          <div class="priority-option">
            <input type="radio" name="priority" id="priorityCritical" value="critical">
            <label for="priorityCritical" class="priority-label label-critical">
              <span class="priority-indicator"></span>
              Critical
            </label>
          </div>
          <div class="priority-option">
            <input type="radio" name="priority" id="priorityUrgent" value="urgent" checked>
            <label for="priorityUrgent" class="priority-label label-urgent">
              <span class="priority-indicator"></span>
              Urgent
            </label>
          </div>
          <div class="priority-option">
            <input type="radio" name="priority" id="priorityStandard" value="standard">
            <label for="priorityStandard" class="priority-label label-standard">
              <span class="priority-indicator"></span>
              Standard
            </label>
          </div>
        </div>
        
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="addNote">Add Task</button>
          <button id="clearAllNotes" class="secondary danger">Clear All</button>
        </div>
      </div>

      <div id="notesList"></div>
    </div>

    <!-- Breathing Exercise -->
    <div class="card">
      <h2>Paced Breathing</h2>
      <p class="tiny">Research-backed breathing patterns to calm your nervous system and restore focus</p>

      <div class="breath-container">
        <div id="circle" class="circle" aria-live="polite">
          <div class="circle-label" id="circleLabel">Ready</div>
        </div>

        <div class="controls">
          <select id="preset">
            <option value="box">Box (4-4-4-4)</option>
            <option value="relax">Relaxing (4-7-8)</option>
            <option value="resonant">Resonant (5-5)</option>
            <option value="energize">Energizing (4-4-6)</option>
          </select>

          <input id="cycles" type="number" min="1" max="20" value="6" style="width:70px" />
          <span class="tiny" style="color:var(--text-muted)">cycles</span>

          <button id="startBreath">Start</button>
          <button id="stopBreath" class="secondary">Stop</button>
        </div>

        <div style="margin-top:20px">
          <label class="tiny">Progress</label>
          <div class="meter">
            <div id="breathProg" class="meter-fill" style="width:0%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Focus Timer -->
    <div class="card">
      <h2>Focus Timer</h2>
      <p class="tiny">Deep work intervals with automatic distraction detection and breathing prompts</p>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
        <div>
          <label>Duration (minutes)</label>
          <input id="minutes" type="number" min="5" max="120" value="25" />
        </div>
        <div>
          <label>Break (minutes)</label>
          <input id="breakMinutes" type="number" min="1" max="30" value="5" />
        </div>
      </div>

      <div class="timer-display" id="timeDisplay">25:00</div>

      <div class="controls">
        <button id="startTimer">▶ Start</button>
        <button id="pauseTimer" class="secondary">⏸ Pause</button>
        <button id="resetTimer" class="secondary">↻ Reset</button>
      </div>

      <div style="margin-top:20px;display:flex;justify-content:space-between;align-items:center">
        <div class="pill">
          <span class="pill-dot"></span>
          <span id="sessionState">Ready</span>
        </div>
        <div class="tiny">Session <strong id="roundCount">0</strong> • Completed <strong id="completedCount">0</strong></div>
      </div>

      <div style="margin-top:20px;display:flex;gap:16px;flex-wrap:wrap;align-items:center">
        <div style="flex:1">
          <label class="switch">
            <input type="checkbox" id="autoBreath" checked />
            <span class="slider"></span>
          </label>
          <span class="tiny" style="margin-left:8px">Auto-breathe on high distraction</span>
        </div>
        <div style="flex:1">
          <label class="switch">
            <input type="checkbox" id="soundToggle" />
            <span class="slider"></span>
          </label>
          <span class="tiny" style="margin-left:8px">Ambient sound</span>
        </div>
      </div>
    </div>

    <!-- Enhanced Focus Meter -->
    <div class="card">
      <h2>Advanced Focus Meter</h2>
      <p class="tiny">AI-powered attention tracking using motion patterns, keyboard activity, and window focus</p>

      <div class="focus-meter-container">
        <div class="focus-score">
          <div>
            <div class="tiny">CURRENT FOCUS SCORE</div>
            <div id="focusScoreDisplay" class="score-value">100</div>
          </div>
          <div style="text-align:right">
            <div class="tiny">STATUS</div>
            <div id="focusStatus" class="pill" style="background:var(--success);border-color:var(--success)">Excellent</div>
          </div>
        </div>

        <div class="meter">
          <div id="focusMeterFill" class="meter-fill" style="width:100%"></div>
        </div>

        <div class="focus-metrics">
          <div class="metric">
            <div class="metric-label">Stability</div>
            <div id="stabilityScore" class="metric-value">95%</div>
          </div>
          <div class="metric">
            <div class="metric-label">Engagement</div>
            <div id="engagementScore" class="metric-value">88%</div>
          </div>
          <div class="metric">
            <div class="metric-label">Consistency</div>
            <div id="consistencyScore" class="metric-value">92%</div>
          </div>
          <div class="metric">
            <div class="metric-label">Window Focus</div>
            <div id="windowScore" class="metric-value">100%</div>
          </div>
        </div>
      </div>

      <div style="margin-top:16px">
        <label>Activity Log</label>
        <div class="event-log" id="eventLog"></div>
        <button id="clearLog" class="secondary" style="margin-top:12px;width:100%">Clear Log</button>
      </div>
    </div>
  </section>

  <!-- Sidebar -->
  <aside>
    <!-- Stats -->
    <div class="card">
      <h2>Today's Progress</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div id="breathCount" class="stat-value">0</div>
          <div class="stat-label">Breath Cycles</div>
        </div>
        <div class="stat-card">
          <div id="focusCount" class="stat-value">0</div>
          <div class="stat-label">Focus Sessions</div>
        </div>
        <div class="stat-card">
          <div id="taskCount" class="stat-value">0</div>
          <div class="stat-label">Tasks Completed</div>
        </div>
        <div class="stat-card">
          <div id="avgFocus" class="stat-value">--</div>
          <div class="stat-label">Avg Focus Score</div>
        </div>
      </div>
    </div>

    <!-- Session History -->
    <div class="card" style="margin-top:20px">
      <h2>Session History</h2>
      <div class="event-log" id="historyLog"></div>
    </div>

    <!-- Quick Tips -->
    <div class="card" style="margin-top:20px">
      <h2>Focus Tips</h2>
      <ul class="tiny" style="line-height:1.8;padding-left:20px">
        <li>When focus drops below 60, take a 2-minute breathing break</li>
        <li>Write specific, actionable tasks in the Task Manager</li>
        <li>Aim for 25-minute focus blocks with 5-minute breaks</li>
        <li>Close unnecessary tabs and notifications before starting</li>
        <li>Track patterns in your activity log to identify distractions</li>
      </ul>
    </div>
  </aside>
</main>

<script>
// Enhanced Sweet Deep with advanced focus tracking and task management

const $ = id => document.getElementById(id);

// ===== TASK MANAGEMENT =====
let notes = JSON.parse(localStorage.getItem('notes') || '[]');

function renderNotes(){
  const container = $('notesList');
  if(notes.length === 0){
    container.innerHTML = '<div class="tiny" style="text-align:center;padding:20px;color:var(--text-muted)">No tasks yet. Add one above to regain your focus.</div>';
    return;
  }
  
  container.innerHTML = notes.map((note,i) => `
    <div class="note-item">
      <div class="note-header">
        <span class="note-priority priority-${note.priority}">${note.priority}</span>
        <div class="note-actions">
          <button class="note-btn" onclick="completeNote(${i})">✓ Done</button>
          <button class="note-btn" onclick="deleteNote(${i})">✕ Delete</button>
        </div>
      </div>
      <div class="note-content">${note.text}</div>
      <div class="note-timestamp">${note.timestamp}</div>
    </div>
  `).join('');
}

function addNote(){
  const text = $('noteText').value.trim();
  if(!text) return;
  
  const priorityRadio = document.querySelector('input[name="priority"]:checked');
  const priority = priorityRadio ? priorityRadio.value : 'urgent';
  
  const note = {
    text,
    priority,
    timestamp: new Date().toLocaleString(),
    id: Date.now()
  };
  
  notes.unshift(note);
  localStorage.setItem('notes', JSON.stringify(notes));
  $('noteText').value = '';
  renderNotes();
  updateStats();
}

function deleteNote(index){
  notes.splice(index, 1);
  localStorage.setItem('notes', JSON.stringify(notes));
  renderNotes();
}

function completeNote(index){
  addHistory(`Task completed: ${notes[index].text.substring(0,50)}...`);
  deleteNote(index);
  updateStat('taskCount');
}

function clearAllNotes(){
  if(notes.length === 0) return;
  if(confirm('Clear all tasks?')){
    notes = [];
    localStorage.setItem('notes', JSON.stringify(notes));
    renderNotes();
  }
}

window.addNote = addNote;
window.deleteNote = deleteNote;
window.completeNote = completeNote;

// ===== BREATHING =====
let breathTimer = null;
let breathRunning = false;
let audioCtx = null;

const presets = {
  box: {inhale:4, hold:4, exhale:4, hold2:4},
  relax: {inhale:4, hold:7, exhale:8, hold2:0},
  resonant: {inhale:5, hold:0, exhale:5, hold2:0},
  energize: {inhale:4, hold:4, exhale:6, hold2:0}
};

function startBreathing(){
  if(breathRunning) return;
  breathRunning = true;
  
  const preset = presets[$('preset').value];
  const cycles = parseInt($('cycles').value);
  
  $('startBreath').disabled = true;
  $('stopBreath').disabled = false;
  $('circleLabel').textContent = 'Starting...';
  
  let currentCycle = 0;
  let stage = 'inhale';
  let stageTime = preset.inhale;
  
  const totalTime = cycles * (preset.inhale + preset.hold + preset.exhale + preset.hold2);
  let elapsed = 0;
  
  const circle = $('circle');
  circle.classList.add('active');
  
  function tick(){
    if(!breathRunning) return;
    
    // Update label
    const stageNames = {inhale:'Inhale', hold:'Hold', exhale:'Exhale', hold2:'Hold'};
    $('circleLabel').textContent = `${stageNames[stage]} ${stageTime}`;
    
    // Visual feedback
    if(stage === 'inhale') circle.style.transform = 'scale(1.15)';
    else if(stage === 'hold' || stage === 'hold2') circle.style.transform = 'scale(1.08)';
    else if(stage === 'exhale') circle.style.transform = 'scale(0.85)';
    
    // Progress
    elapsed++;
    $('breathProg').style.width = `${(elapsed/totalTime)*100}%`;
    
    stageTime--;
    
    if(stageTime <= 0){
      // Next stage
      if(stage === 'inhale'){
        stage = preset.hold > 0 ? 'hold' : 'exhale';
        stageTime = preset.hold > 0 ? preset.hold : preset.exhale;
      } else if(stage === 'hold'){
        stage = 'exhale';
        stageTime = preset.exhale;
      } else if(stage === 'exhale'){
        stage = preset.hold2 > 0 ? 'hold2' : 'inhale';
        if(stage === 'hold2'){
          stageTime = preset.hold2;
        } else {
          currentCycle++;
          if(currentCycle >= cycles){
            stopBreathing();
            return;
          }
          stageTime = preset.inhale;
        }
      } else if(stage === 'hold2'){
        currentCycle++;
        if(currentCycle >= cycles){
          stopBreathing();
          return;
        }
        stage = 'inhale';
        stageTime = preset.inhale;
      }
      playBeep(stage === 'exhale' ? 330 : 440);
    }
    
    breathTimer = setTimeout(tick, 1000);
  }
  
  tick();
  updateStat('breathCount');
  addHistory('Breathing session started');
}

function stopBreathing(){
  breathRunning = false;
  clearTimeout(breathTimer);
  $('startBreath').disabled = false;
  $('stopBreath').disabled = true;
  $('circleLabel').textContent = 'Complete';
  $('circle').style.transform = 'scale(1)';
  $('circle').classList.remove('active');
  setTimeout(()=>{
    $('circleLabel').textContent = 'Ready';
    $('breathProg').style.width = '0%';
  }, 2000);
  addHistory('Breathing session completed');
}

// ===== FOCUS TIMER =====
let focusTimer = null;
let focusRemaining = 0;
let focusRunning = false;
let focusPaused = false;

function startFocus(){
  if(focusRunning && !focusPaused){
    return;
  }
  
  if(!focusPaused){
    const mins = parseInt($('minutes').value);
    focusRemaining = mins * 60;
  }
  
  focusRunning = true;
  focusPaused = false;
  $('sessionState').textContent = 'Active';
  $('startTimer').disabled = true;
  $('pauseTimer').disabled = false;
  
  updateStat('focusCount');
  addHistory(`Focus session started (${$('minutes').value}m)`);
  
  focusTick();
}

function focusTick(){
  if(!focusRunning || focusPaused) return;
  
  const mins = Math.floor(focusRemaining / 60);
  const secs = focusRemaining % 60;
  $('timeDisplay').textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
  
  if(focusRemaining <= 0){
    completeFocus();
    return;
  }
  
  // Auto-breathe check
  if($('autoBreath').checked && getFocusScore() < 50 && !breathRunning){
    addHistory('Low focus detected - starting breathing');
    startBreathing();
  }
  
  focusRemaining--;
  focusTimer = setTimeout(focusTick, 1000);
}

function pauseFocus(){
  focusPaused = true;
  focusRunning = false;
  clearTimeout(focusTimer);
  $('sessionState').textContent = 'Paused';
  $('startTimer').disabled = false;
  $('pauseTimer').disabled = true;
}

function resetFocus(){
  focusRunning = false;
  focusPaused = false;
  clearTimeout(focusTimer);
  const mins = parseInt($('minutes').value);
  focusRemaining = mins * 60;
  $('timeDisplay').textContent = `${mins.toString().padStart(2,'0')}:00`;
  $('sessionState').textContent = 'Ready';
  $('startTimer').disabled = false;
  $('pauseTimer').disabled = true;
}

function completeFocus(){
  focusRunning = false;
  focusPaused = false;
  clearTimeout(focusTimer);
  $('sessionState').textContent = 'Complete!';
  $('startTimer').disabled = false;
  $('pauseTimer').disabled = true;
  
  const count = parseInt($('completedCount').textContent) + 1;
  $('completedCount').textContent = count;
  const round = parseInt($('roundCount').textContent) + 1;
  $('roundCount').textContent = round;
  
  addHistory(`Focus session completed!`);
  playBeep(554, 0.2);
  
  // Start break
  setTimeout(()=>{
    if(confirm('Session complete! Start break timer?')){
      const breakMins = parseInt($('breakMinutes').value);
      $('minutes').value = breakMins;
      resetFocus();
    }
  }, 1000);
}

// ===== ADVANCED FOCUS TRACKING =====
let mouseMovements = [];
let keyPresses = [];
let tabSwitches = 0;
let lastMousePos = {x:0, y:0};
let lastKeyTime = 0;
let focusScores = [];
let isWindowFocused = true;

function addEvent(text, type='info'){
  const log = $('eventLog');
  const time = new Date().toLocaleTimeString();
  const div = document.createElement('div');
  div.className = 'event-item';
  div.innerHTML = `
    <span>${text}</span>
    <div>
      <span class="event-time">${time}</span>
      <button class="delete-event" onclick="this.parentElement.parentElement.remove()">×</button>
    </div>
  `;
  log.insertBefore(div, log.firstChild);
  
  while(log.children.length > 50){
    log.removeChild(log.lastChild);
  }
}

function addHistory(text){
  const log = $('historyLog');
  const time = new Date().toLocaleTimeString();
  const div = document.createElement('div');
  div.className = 'event-item';
  div.innerHTML = `<span>${text}</span><span class="event-time">${time}</span>`;
  log.insertBefore(div, log.firstChild);
  
  while(log.children.length > 30){
    log.removeChild(log.lastChild);
  }
}

// Mouse tracking
document.addEventListener('mousemove', e => {
  const dx = e.clientX - lastMousePos.x;
  const dy = e.clientY - lastMousePos.y;
  const distance = Math.sqrt(dx*dx + dy*dy);
  const speed = distance / 16; // pixels per frame
  
  mouseMovements.push({
    distance,
    speed,
    time: Date.now()
  });
  
  if(mouseMovements.length > 100){
    mouseMovements.shift();
  }
  
  if(distance > 200){
    addEvent(`Large mouse movement detected (${Math.round(distance)}px)`, 'warning');
  }
  
  lastMousePos = {x: e.clientX, y: e.clientY};
});

// Keyboard tracking
document.addEventListener('keydown', e => {
  const now = Date.now();
  const timeSinceLast = now - lastKeyTime;
  
  keyPresses.push({
    key: e.key,
    time: now,
    interval: timeSinceLast
  });
  
  if(keyPresses.length > 100){
    keyPresses.shift();
  }
  
  lastKeyTime = now;
});

// Window focus tracking
document.addEventListener('visibilitychange', () => {
  if(document.hidden){
    isWindowFocused = false;
    tabSwitches++;
    addEvent('Window lost focus', 'warning');
  } else {
    isWindowFocused = true;
    addEvent('Window regained focus');
  }
});

window.addEventListener('blur', () => {
  isWindowFocused = false;
});

window.addEventListener('focus', () => {
  isWindowFocused = true;
});

// Calculate comprehensive focus score
function getFocusScore(){
  const now = Date.now();
  
  // 1. Mouse stability (lower erratic movement = higher score)
  const recentMouse = mouseMovements.filter(m => now - m.time < 10000);
  const avgSpeed = recentMouse.reduce((sum,m) => sum + m.speed, 0) / (recentMouse.length || 1);
  const mouseStability = Math.max(0, 100 - (avgSpeed * 2));
  
  // 2. Keyboard consistency (steady typing = higher score)
  const recentKeys = keyPresses.filter(k => now - k.time < 15000);
  const avgInterval = recentKeys.reduce((sum,k) => sum + k.interval, 0) / (recentKeys.length || 1);
  const keyConsistency = recentKeys.length > 5 ? Math.min(100, (recentKeys.length * 3)) : 50;
  
  // 3. Window focus (focused = 100, unfocused = 0)
  const windowFocus = isWindowFocused ? 100 : 0;
  
  // 4. Tab switch penalty
  const tabPenalty = Math.min(50, tabSwitches * 5);
  
  // 5. Idle detection (recent activity = higher score)
  const timeSinceLastKey = now - lastKeyTime;
  const idleScore = timeSinceLastKey < 5000 ? 100 : Math.max(0, 100 - (timeSinceLastKey / 1000));
  
  // Weighted composite score
  const score = (
    mouseStability * 0.25 +
    keyConsistency * 0.25 +
    windowFocus * 0.3 +
    idleScore * 0.2
  ) - tabPenalty;
  
  return Math.max(0, Math.min(100, score));
}

function updateFocusDisplay(){
  const score = getFocusScore();
  focusScores.push(score);
  if(focusScores.length > 20) focusScores.shift();
  
  const avgScore = focusScores.reduce((a,b)=>a+b,0) / focusScores.length;
  
  $('focusScoreDisplay').textContent = Math.round(score);
  $('focusMeterFill').style.width = `${score}%`;
  
  // Update status
  const scoreEl = $('focusScoreDisplay');
  const statusEl = $('focusStatus');
  
  if(score >= 80){
    scoreEl.className = 'score-value';
    statusEl.textContent = 'Excellent';
    statusEl.style.background = 'var(--success)';
    statusEl.style.borderColor = 'var(--success)';
  } else if(score >= 60){
    scoreEl.className = 'score-value';
    statusEl.textContent = 'Good';
    statusEl.style.background = 'var(--accent)';
    statusEl.style.borderColor = 'var(--accent)';
  } else if(score >= 40){
    scoreEl.className = 'score-value warning';
    statusEl.textContent = 'Moderate';
    statusEl.style.background = 'var(--warning)';
    statusEl.style.borderColor = 'var(--warning)';
  } else {
    scoreEl.className = 'score-value danger';
    statusEl.textContent = 'Low';
    statusEl.style.background = 'var(--danger)';
    statusEl.style.borderColor = 'var(--danger)';
  }
  
  // Update metrics
  const recentMouse = mouseMovements.filter(m => Date.now() - m.time < 10000);
  const avgSpeed = recentMouse.reduce((sum,m) => sum + m.speed, 0) / (recentMouse.length || 1);
  const stability = Math.max(0, 100 - (avgSpeed * 2));
  
  const recentKeys = keyPresses.filter(k => Date.now() - k.time < 15000);
  const engagement = recentKeys.length > 5 ? Math.min(100, (recentKeys.length * 3)) : 50;
  
  const consistency = Math.round(avgScore);
  const windowScore = isWindowFocused ? 100 : 0;
  
  $('stabilityScore').textContent = Math.round(stability) + '%';
  $('engagementScore').textContent = Math.round(engagement) + '%';
  $('consistencyScore').textContent = consistency + '%';
  $('windowScore').textContent = windowScore + '%';
  
  // Update average
  if(focusScores.length > 0){
    $('avgFocus').textContent = Math.round(avgScore);
  }
}

// ===== AUDIO =====
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function playBeep(freq = 440, duration = 0.1){
  try{
    ensureAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    
    osc.frequency.value = freq;
    osc.type = 'sine';
    
    gain.gain.value = 0;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    const now = audioCtx.currentTime;
    gain.gain.linearRampToValueAtTime(0.1, now + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
    
    osc.start(now);
    osc.stop(now + duration);
  } catch(e){
    console.log('Audio not available');
  }
}

let ambientNode = null;
function toggleAmbient(){
  if(!$('soundToggle').checked){
    if(ambientNode){
      try{ ambientNode.stop(); } catch(e){}
      ambientNode = null;
    }
    return;
  }
  
  ensureAudio();
  const bufferSize = audioCtx.sampleRate * 2;
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  
  for(let i = 0; i < bufferSize; i++){
    data[i] = (Math.random() * 2 - 1) * 0.15;
  }
  
  ambientNode = audioCtx.createBufferSource();
  ambientNode.buffer = buffer;
  ambientNode.loop = true;
  
  const filter = audioCtx.createBiquadFilter();
  filter.type = 'lowpass';
  filter.frequency.value = 800;
  
  const gain = audioCtx.createGain();
  gain.gain.value = 0.1;
  
  ambientNode.connect(filter);
  filter.connect(gain);
  gain.connect(audioCtx.destination);
  ambientNode.start();
}

// ===== STATS =====
function updateStat(key){
  const current = parseInt(localStorage.getItem(key) || '0');
  localStorage.setItem(key, current + 1);
  $(key).textContent = current + 1;
}

function updateStats(){
  $('breathCount').textContent = localStorage.getItem('breathCount') || '0';
  $('focusCount').textContent = localStorage.getItem('focusCount') || '0';
  $('taskCount').textContent = localStorage.getItem('taskCount') || '0';
}

// ===== EVENT LISTENERS =====
$('addNote').addEventListener('click', addNote);
$('clearAllNotes').addEventListener('click', clearAllNotes);
$('noteText').addEventListener('keydown', e => {
  if(e.key === 'Enter' && e.ctrlKey){
    addNote();
  }
});

$('startBreath').addEventListener('click', startBreathing);
$('stopBreath').addEventListener('click', stopBreathing);

$('startTimer').addEventListener('click', startFocus);
$('pauseTimer').addEventListener('click', pauseFocus);
$('resetTimer').addEventListener('click', resetFocus);

$('soundToggle').addEventListener('change', toggleAmbient);

$('clearLog').addEventListener('click', () => {
  $('eventLog').innerHTML = '';
  tabSwitches = 0;
  addEvent('Log cleared');
});

// ===== INITIALIZATION =====
renderNotes();
updateStats();
updateFocusDisplay();

// Update focus meter every 500ms
setInterval(updateFocusDisplay, 500);

// Periodic decay of counters
setInterval(() => {
  if(tabSwitches > 0) tabSwitches = Math.max(0, tabSwitches - 0.1);
}, 5000);

// Auto-save notes
setInterval(() => {
  localStorage.setItem('notes', JSON.stringify(notes));
}, 30000);

addHistory('Sweet Deep Enhanced initialized');
</script>
</body>
</html>
